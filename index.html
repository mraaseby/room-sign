<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Room Schedule</title>
  <style>
    body { margin:0; font-family: Arial, sans-serif; background:#000; color:#fff; }
    .wrap { display:grid; grid-template-columns: 2fr 1fr; min-height:100vh; }
    .main { padding:32px; }
    .side { background:#ddd; color:#000; padding:20px; }
    h1 { margin:0 0 8px 0; font-size:28px; opacity:.92; }
    h2 { margin:18px 0 10px 0; font-size:18px; opacity:.9; }
    .event { padding:14px 0; border-bottom:1px solid rgba(255,255,255,.15); }
    .time { font-size:14px; opacity:.8; }
    .title { font-size:22px; font-weight:700; margin-top:4px; }
    .smallEvent { padding:10px 0; border-bottom:1px solid rgba(0,0,0,.15); }
    .qr { margin-top:10px; background:#fff; padding:10px; display:inline-block; border-radius:10px; }
    .note { font-size:12px; opacity:.75; margin-top:10px; }
    .pill { display:inline-block; padding:6px 10px; border-radius:999px; background:#222; color:#fff; font-size:12px; opacity:.85; }
    .error { background:#b00020; color:#fff; padding:10px; border-radius:10px; margin-top:12px; }
    code { word-break: break-all; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="main">
      <h1 id="roomName">Room Schedule</h1>
      <div class="pill" id="status">Loading…</div>
      <div id="err" class="error" style="display:none;"></div>

      <h2>Today</h2>
      <div id="today"></div>

      <h2>Tomorrow</h2>
      <div id="tomorrow"></div>

      <h2>Debug (next 10 events)</h2>
      <div id="debug"></div>

      <div class="note">Auto-refreshes every 5 minutes.</div>
    </div>

    <div class="side">
      <h2>Book this room</h2>
      <div class="qr"><img id="qrImg" alt="QR code" /></div>
      <div style="margin-top:10px; font-size:13px;">
        <div><strong>Booking link:</strong></div>
        <code id="bookUrlText"></code>
      </div>

      <h2 style="margin-top:22px;">Upcoming</h2>
      <div id="upcoming"></div>
    </div>
  </div>

<script>
  // ================== CONFIG (EDIT THESE) ==================
  const ROOM_NAME = "Room Pacific";
  const BOOKING_URL = "PASTE_BOOKING_LINK_HERE";
  const APPS_SCRIPT_PROXY = "https://script.google.com/macros/s/AKfycbwj8qKwz2oZTuXdHWpJexroYDSM-BoZUP0h4FriaBvgB2FYDLP3l8j_2UQQ_wp57lXo/exec"; // https://script.google.com/macros/s/.../exec
  const ICS_URL = "https://calendar.google.com/calendar/ical/c_494aa0780fd1753a7f0239a30cc7da00b8d05099113ce7799078445a9bacfa62%40group.calendar.google.com/public/basic.ics";
 // =========================================================

  document.getElementById("roomName").textContent = ROOM_NAME;

  // QR code (no libraries)
  document.getElementById("qrImg").src =
    "https://chart.googleapis.com/chart?cht=qr&chs=220x220&chl=" + encodeURIComponent(BOOKING_URL);
  document.getElementById("bookUrlText").textContent = BOOKING_URL;

  function showError(msg) {
    const el = document.getElementById("err");
    el.style.display = "block";
    el.innerHTML = msg;
  }

  function sameDay(a, b) {
    return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();
  }
  function fmtTime(d) {
    return d.toLocaleTimeString([], { hour:"2-digit", minute:"2-digit" });
  }
  function escapeHtml(s) {
    return String(s || "").replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[c]));
  }

  function renderList(el, list, big=true) {
    el.innerHTML = list.length ? "" : "<div style='opacity:.7'>No reservations</div>";
    for (const e of list) {
      const div = document.createElement("div");
      div.className = big ? "event" : "smallEvent";
      div.innerHTML = `
        <div class="time">${fmtTime(e.start)} – ${fmtTime(e.end)}</div>
        <div class="${big ? "title":""}">${escapeHtml(e.summary)}</div>
      `;
      el.appendChild(div);
    }
  }

  async function load() {
    try {
      const url = APPS_SCRIPT_PROXY + "?ics=" + encodeURIComponent(ICS_URL);
      console.log("Fetching:", url);

      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error("Fetch failed: HTTP " + res.status);

      const data = await res.json();
      console.log("Data:", data);

      const now = new Date();
      const today0 = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const tomorrow0 = new Date(today0); tomorrow0.setDate(today0.getDate() + 1);

      const parsed = (data.events || []).map(e => ({
        start: new Date(e.start),
        end: new Date(e.end),
        summary: e.summary || "Reserved"
      })).filter(e => !isNaN(e.start) && !isNaN(e.end))
        .sort((a,b) => a.start - b.start);

      const todays = parsed.filter(e => sameDay(e.start, today0));
      const tomorrows = parsed.filter(e => sameDay(e.start, tomorrow0));

      const next10 = parsed.filter(e => e.end > now).slice(0, 10);
      const upcoming = parsed.filter(e => e.end > now).slice(0, 6);

      renderList(document.getElementById("today"), todays, true);
      renderList(document.getElementById("tomorrow"), tomorrows, true);
      renderList(document.getElementById("debug"), next10, false);
      renderList(document.getElementById("upcoming"), upcoming, false);

      document.getElementById("status").textContent =
        "Updated " + now.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});

    } catch (err) {
      console.error(err);
      showError("Error: " + escapeHtml(err.message) + "<br><br>" +
        "Check your config values (BOOKING_URL, APPS_SCRIPT_PROXY (/exec), ICS_URL).");
      document.getElementById("status").textContent = "Error";
    }
  }

  load();
  setInterval(load, 5 * 60 * 1000);
</script>
</body>
</html>
